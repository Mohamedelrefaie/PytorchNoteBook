<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>fastai datacore | Bowenroom</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="fastai datacore" />
<meta name="author" content="Bowen" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="borrow code from https://docs.fast.ai/data.core.html add some tips" />
<meta property="og:description" content="borrow code from https://docs.fast.ai/data.core.html add some tips" />
<link rel="canonical" href="https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-datacore.html" />
<meta property="og:url" content="https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-datacore.html" />
<meta property="og:site_name" content="Bowenroom" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-31T00:00:00-06:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Bowen"},"description":"borrow code from https://docs.fast.ai/data.core.html add some tips","@type":"BlogPosting","headline":"fastai datacore","dateModified":"2021-01-31T00:00:00-06:00","datePublished":"2021-01-31T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-datacore.html"},"url":"https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-datacore.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/myBlog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://bowenroom.github.io/myBlog/feed.xml" title="Bowenroom" /><link rel="shortcut icon" type="image/x-icon" href="/myBlog/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>fastai datacore | Bowenroom</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="fastai datacore" />
<meta name="author" content="Bowen" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="borrow code from https://docs.fast.ai/data.core.html add some tips" />
<meta property="og:description" content="borrow code from https://docs.fast.ai/data.core.html add some tips" />
<link rel="canonical" href="https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-datacore.html" />
<meta property="og:url" content="https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-datacore.html" />
<meta property="og:site_name" content="Bowenroom" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-31T00:00:00-06:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Bowen"},"description":"borrow code from https://docs.fast.ai/data.core.html add some tips","@type":"BlogPosting","headline":"fastai datacore","dateModified":"2021-01-31T00:00:00-06:00","datePublished":"2021-01-31T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-datacore.html"},"url":"https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-datacore.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://bowenroom.github.io/myBlog/feed.xml" title="Bowenroom" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/myBlog/">Bowenroom</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/myBlog/about/">About Me</a><a class="page-link" href="/myBlog/search/">Search</a><a class="page-link" href="/myBlog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">fastai datacore</h1><p class="page-description">borrow code from https://docs.fast.ai/data.core.html add some tips</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-01-31T00:00:00-06:00" itemprop="datePublished">
        Jan 31, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Bowen</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      23 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/myBlog/categories/#pytorch">pytorch</a>
        &nbsp;
      
        <a class="category-tags-link" href="/myBlog/categories/#fastai">fastai</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/bowenroom/myBlog/tree/master/_notebooks/2021-01-31-fastai-datacore.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/myBlog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/bowenroom/myBlog/master?filepath=_notebooks%2F2021-01-31-fastai-datacore.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/myBlog/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/bowenroom/myBlog/blob/master/_notebooks/2021-01-31-fastai-datacore.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/myBlog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Data-core">Data core </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Methods">Methods </a></li>
<li class="toc-entry toc-h3"><a href="#Methods">Methods </a>
<ul>
<li class="toc-entry toc-h4"><a href="#DataLoaders.__getitem__">DataLoaders.__getitem__[source]</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Norm变换example">Norm变换example </a></li>
<li class="toc-entry toc-h3"><a href="#Methods">Methods </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Datasets.dataloaders">Datasets.dataloaders[source]</a></li>
<li class="toc-entry toc-h4"><a href="#Datasets.decode">Datasets.decode[source]</a></li>
<li class="toc-entry toc-h4"><a href="#Datasets.show">Datasets.show[source]</a></li>
<li class="toc-entry toc-h4"><a href="#Datasets.new_empty">Datasets.new_empty[source]</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Add-test-set-for-inference">Add test set for inference </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-01-31-fastai-datacore.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span> <span class="o">[</span> -e /content <span class="o">]</span> <span class="o">&amp;&amp;</span> pip install -Uqq fastai  # upgrade fastai on colab
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.torch_basics</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.data.load</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">'/home/ubuntu/.fastai/data/isprs/'</span><span class="p">)</span>
<span class="n">data_path</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span>
<span class="c1"># path_img = data_path/'2_Ortho_RGB'</span>
<span class="c1"># path_lbl = data_path/'5_Labels_for_participants'</span>
<span class="n">path_img</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">/</span> <span class="s1">'Potsdam/2_Ortho_RGB/train_pick'</span>
<span class="n">path_lbl</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">/</span> <span class="s1">'Potsdam/5_Labels_for_participants'</span>
<span class="n">fnames</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path_img</span><span class="p">)</span>
<span class="n">fnames</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
<span class="n">lbl_names</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path_lbl</span><span class="p">)</span>
<span class="n">lbl_names</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#7) [Path('/home/ubuntu/.fastai/data/isprs/5_Labels_for_participants.zip'),Path('/home/ubuntu/.fastai/data/isprs/4_Ortho_RGBIR.zip'),Path('/home/ubuntu/.fastai/data/isprs/haze'),Path('/home/ubuntu/.fastai/data/isprs/2_Ortho_RGB.zip'),Path('/home/ubuntu/.fastai/data/isprs/Vaihingen'),Path('/home/ubuntu/.fastai/data/isprs/Potsdam'),Path('/home/ubuntu/.fastai/data/isprs/bak')]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#3) [Path('/home/ubuntu/.fastai/data/isprs/Potsdam/2_Ortho_RGB/train_pick/top_potsdam_7_9_RGB.tif'),Path('/home/ubuntu/.fastai/data/isprs/Potsdam/2_Ortho_RGB/train_pick/top_potsdam_5_10_RGB.tif'),Path('/home/ubuntu/.fastai/data/isprs/Potsdam/2_Ortho_RGB/train_pick/top_potsdam_5_11_RGB.tif')]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#3) [Path('/home/ubuntu/.fastai/data/isprs/Potsdam/5_Labels_for_participants/top_potsdam_7_7_label.tif'),Path('/home/ubuntu/.fastai/data/isprs/Potsdam/5_Labels_for_participants/top_potsdam_2_10_label.tif'),Path('/home/ubuntu/.fastai/data/isprs/Potsdam/5_Labels_for_participants/top_potsdam_6_8_label.tif')]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Data-core">
<a class="anchor" href="#Data-core" aria-hidden="true"><span class="octicon octicon-link"></span></a>Data core<a class="anchor-link" href="#Data-core"> </a>
</h1>
<blockquote>
<p>Core functionality for gathering data</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The classes here provide functionality for applying a list of transforms to a set of items (<code>TfmdLists</code>, <code>Datasets</code>) or a <code>DataLoader</code> (<code>TfmdDl</code>) as well as the base class used to gather the data for model training: <code>DataLoaders</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@typedispatch</span>
<span class="k">def</span> <span class="nf">show_batch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">ctxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ctxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ctxs</span> <span class="o">=</span> <span class="n">Inf</span><span class="o">.</span><span class="n">nones</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'show'</span><span class="p">):</span>
        <span class="n">ctxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span><span class="n">ctxs</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">max_n</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">range_of</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ctxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">itemgot</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">ctxs</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">max_n</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">ctxs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>show_batch</code> is a type-dispatched function that is responsible for showing decoded <code>samples</code>. <code>x</code> and <code>y</code> are the input and the target in the batch to be shown, and are passed along to dispatch on their types. There is a different implementation of <code>show_batch</code> if <code>x</code> is a <code>TensorImage</code> or a <code>TensorText</code> for instance (see vision.core or text.data for more details). <code>ctxs</code> can be passed but the function is responsible to create them if necessary. <code>kwargs</code> depend on the specific implementation.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@typedispatch</span>
<span class="k">def</span> <span class="nf">show_results</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">outs</span><span class="p">,</span> <span class="n">ctxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ctxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ctxs</span> <span class="o">=</span> <span class="n">Inf</span><span class="o">.</span><span class="n">nones</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">ctxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">itemgot</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">ctxs</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">max_n</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">ctxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">outs</span><span class="o">.</span><span class="n">itemgot</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">ctxs</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">max_n</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">ctxs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>show_results</code> is a type-dispatched function that is responsible for showing decoded <code>samples</code> and their corresponding <code>outs</code>. Like in <code>show_batch</code>, <code>x</code> and <code>y</code> are the input and the target in the batch to be shown, and are passed along to dispatch on their types. <code>ctxs</code> can be passed but the function is responsible to create them if necessary. <code>kwargs</code> depend on the specific implementation.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_all_</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"show_batch"</span><span class="p">,</span> <span class="s2">"show_results"</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_batch_tfms</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'after_item'</span><span class="p">,</span><span class="s1">'before_batch'</span><span class="p">,</span><span class="s1">'after_batch'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@delegates</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">TfmdDL</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
    <span class="s2">"Transformed `DataLoader`"</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">num_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">_batch_tfms</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_setup</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">_batch_tfms</span><span class="p">:</span>
                <span class="n">pv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Setting up </span><span class="si">{</span><span class="n">nm</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_one_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_batch</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">do_item</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">b</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">its</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_inp</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">its</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">its</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">its</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_types</span> <span class="o">=</span> <span class="n">explode_types</span><span class="p">(</span><span class="n">its</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_retain_dl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'_types'</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_one_pass</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">retain_types</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">typs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">)</span>

    <span class="nd">@delegates</span><span class="p">(</span><span class="n">DataLoader</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">do_setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'_n_inp'</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'_types'</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_one_pass</span><span class="p">()</span>
                <span class="n">res</span><span class="o">.</span><span class="n">_n_inp</span><span class="p">,</span><span class="n">res</span><span class="o">.</span><span class="n">_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_inp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_types</span>
            <span class="k">except</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">"Could not do one pass in your dataloader, there is something wrong in it"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">_n_inp</span><span class="p">,</span><span class="n">res</span><span class="o">.</span><span class="n">_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_inp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_types</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">before_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">before_iter</span><span class="p">()</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">'split_idx'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">_batch_tfms</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">Pipeline</span><span class="p">):</span> <span class="n">f</span><span class="o">.</span><span class="n">split_idx</span><span class="o">=</span><span class="n">split_idx</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="n">to_cpu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_retain_dl</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
    <span class="k">def</span> <span class="nf">decode_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">max_n</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_decode_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_item</span><span class="o">.</span><span class="n">decode</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_batch</span><span class="o">.</span><span class="n">decode</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span><span class="s1">'decode'</span><span class="p">,</span><span class="n">noop</span><span class="p">),</span> <span class="n">full</span> <span class="o">=</span> <span class="n">full</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="n">batch_to_samples</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="n">max_n</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pre_show_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
        <span class="s2">"Decode `b` to be ready for `show_batch`"</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">'show'</span><span class="p">):</span> <span class="k">return</span> <span class="n">b</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
        <span class="n">its</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_batch</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">max_n</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_listy</span><span class="p">(</span><span class="n">b</span><span class="p">):</span> <span class="n">b</span><span class="p">,</span><span class="n">its</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">],</span><span class="n">L</span><span class="p">((</span><span class="n">o</span><span class="p">,)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">its</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">detuplify</span><span class="p">(</span><span class="n">b</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inp</span><span class="p">]),</span><span class="n">detuplify</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inp</span><span class="p">:]),</span><span class="n">its</span>

    <span class="k">def</span> <span class="nf">show_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">ctxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
            <span class="n">old_get_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_idxs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_idxs</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">Inf</span><span class="o">.</span><span class="n">zeros</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">show</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_show_batch</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="n">max_n</span><span class="p">)</span>
        <span class="n">show_batch</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_pre_show_batch</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="n">max_n</span><span class="p">),</span> <span class="n">ctxs</span><span class="o">=</span><span class="n">ctxs</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="n">max_n</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unique</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_idxs</span> <span class="o">=</span> <span class="n">old_get_idxs</span>

    <span class="k">def</span> <span class="nf">show_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">ctxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">its</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="n">max_n</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">b_out</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">)(</span><span class="n">b</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inp</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_listy</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">out</span><span class="p">,)))</span>
        <span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">b_out</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="n">max_n</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">its</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">its</span><span class="p">,</span> <span class="n">outs</span><span class="o">.</span><span class="n">itemgot</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inp</span><span class="p">,</span><span class="kc">None</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">show</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span>
        <span class="n">show_results</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">ctxs</span><span class="o">=</span><span class="n">ctxs</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="n">max_n</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_inp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">'n_inp'</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">n_inp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'_n_inp'</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_one_pass</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_inp</span>

    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="k">for</span> <span class="n">tfm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">L</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="s1">'parameters'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A <code>TfmdDL</code> is a <code>DataLoader</code> that creates <code>Pipeline</code> from a list of <code>Transform</code>s for the callbacks <code>after_item</code>, <code>before_batch</code> and <code>after_batch</code>. As a result, it can decode or show a processed <code>batch</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>(TfmdDL,
         decode="Decode <code>b</code> using <code>tfms</code>",
         decode_batch="Decode <code>b</code> entirely",
         new="Create a new version of self with a few changed attributes",
         show_batch="Show <code>b</code> (defaults to <code>one_batch</code>), a list of lists of pipeline outputs (i.e. output of a <code>DataLoader</code>)",
         show_results="Show each item of <code>b</code> and <code>out</code>",
         before_iter="override",
         to="Put self and its transforms state on <code>device</code>")</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">_Category</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">ShowTitle</span><span class="p">):</span> <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">aa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">aa</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[-1.2118,  0.8821,  0.2013, -0.3173,  0.5078]])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>TensorImage<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Test retain type</span>
<span class="k">class</span> <span class="nc">NegTfm</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">neg</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">neg</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
<span class="n">tdl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">([(</span><span class="n">TensorImage</span><span class="p">([</span><span class="mi">1</span><span class="p">]),)]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">NegTfm</span><span class="p">(),</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">tdl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">b</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">TensorImage</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">]),)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">decode_batch</span><span class="p">(</span><span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">TensorImage</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(TensorImage([[-1],
         [-1],
         [-1],
         [-1]]),)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bb</span> <span class="o">=</span> <span class="n">NegTfm</span><span class="p">()(</span><span class="n">aa</span><span class="p">)</span>
<span class="n">bb</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[ 1.2118, -0.8821, -0.2013,  0.3173, -0.5078]])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">NegTfm</span><span class="p">()</span><span class="o">.</span><span class="n">decodes</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[-1.2118,  0.8821,  0.2013, -0.3173,  0.5078]])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span> 
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span> 
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">TitledInt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> 

<span class="nd">@Transform</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">fastuple</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">fastuple</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">start</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,
        18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,
        36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">tdl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">after_item</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">tdl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">x</span>
<span class="n">y</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">fastuple</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">tdl</span><span class="o">.</span><span class="n">decode_batch</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
<span class="n">s</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fastuple</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([0, 1, 2, 3])</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([0, 1, 2, 3]), tensor([0, 1, 2, 3]))</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#4) [(tensor(0), (tensor(0), tensor(0))),(tensor(1), (tensor(1), tensor(1))),(tensor(2), (tensor(2), tensor(2))),(tensor(3), (tensor(3), tensor(3)))]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">tdl</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([0, 1, 2, 3]), (tensor([0, 1, 2, 3]), tensor([0, 1, 2, 3])))</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([4, 5, 6, 7]), (tensor([4, 5, 6, 7]), tensor([4, 5, 6, 7])))</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tdl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">after_item</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span> <span class="p">:</span> <span class="n">o</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tdl</span>
<span class="n">L</span><span class="p">(</span><span class="n">tdl</span><span class="p">)</span>
<span class="c1"># tdl.show_batch()</span>
<span class="c1"># 此处无法使用show_batch, 因为无法对tensor使用这个功能,不过下面的代码中,经过A函数编码之后,输出了一个list,可以进行show功能</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;__main__.TfmdDL at 0x7fda20b2e670&gt;</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#1) [tensor([-2, -4, -6, -8])]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">aa</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">bb</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span><span class="n">bb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">temp</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">temp</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">temp</span><span class="p">(</span><span class="n">aa</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[1, 2, 3]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>list</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tdl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span> <span class="n">after_item</span><span class="o">=</span><span class="n">A</span><span class="p">(),</span>  <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">tdl</span><span class="o">.</span><span class="n">dataset</span>
<span class="n">tdl</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">L</span><span class="p">(</span><span class="n">tdl</span><span class="p">)</span>
<span class="n">tdl</span><span class="o">.</span><span class="n">show_batch</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tdl</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">show_batch</span><span class="p">,</span> <span class="s1">'0</span><span class="se">\n</span><span class="s1">1</span><span class="se">\n</span><span class="s1">2</span><span class="se">\n</span><span class="s1">3'</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">show_batch</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s1">'0</span><span class="se">\n</span><span class="s1">0</span><span class="se">\n</span><span class="s1">0</span><span class="se">\n</span><span class="s1">0'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,
        18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,
        36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49])</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0)</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#13) [tensor([0, 1, 2, 3]),tensor([4, 5, 6, 7]),tensor([ 8,  9, 10, 11]),tensor([12, 13, 14, 15]),tensor([16, 17, 18, 19]),tensor([20, 21, 22, 23]),tensor([24, 25, 26, 27]),tensor([28, 29, 30, 31]),tensor([32, 33, 34, 35]),tensor([36, 37, 38, 39])...]</pre>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0
1
2
3
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tdl</span>
<span class="n">tdl</span><span class="o">.</span><span class="n">dataset</span>
<span class="nb">len</span><span class="p">(</span><span class="n">tdl</span><span class="p">)</span>
<span class="n">L</span><span class="p">(</span><span class="n">tdl</span><span class="p">)</span>
<span class="n">tdl</span><span class="o">.</span><span class="n">show_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;__main__.TfmdDL at 0x7fda2052fd90&gt;</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,
        18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,
        36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49])</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>13</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#13) [tensor([ 0, -1, -2, -3]),tensor([-4, -5, -6, -7]),tensor([ -8,  -9, -10, -11]),tensor([-12, -13, -14, -15]),tensor([-16, -17, -18, -19]),tensor([-20, -21, -22, -23]),tensor([-24, -25, -26, -27]),tensor([-28, -29, -30, -31]),tensor([-32, -33, -34, -35]),tensor([-36, -37, -38, -39])...]</pre>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0
1
2
3
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">default_device</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type='cuda', index=0)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>NegTfm<span class="o">?</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">default_device</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type='cuda', index=1)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="s1">'a'</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="n">x</span>

<span class="n">tdl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">([(</span><span class="n">TensorImage</span><span class="p">([</span><span class="mi">1</span><span class="p">]),)]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="p">[</span><span class="n">B</span><span class="p">(),</span><span class="n">NegTfm</span><span class="p">()],</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">tdl</span>
<span class="n">tdl</span><span class="o">.</span><span class="n">after_batch</span>
<span class="c1"># fs means functions </span>
<span class="n">tdl</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span>
<span class="n">tdl</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">device</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">))</span>
<span class="n">tdl</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">default_device</span><span class="p">())</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">default_device</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;__main__.TfmdDL at 0x7fda21023640&gt;</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Pipeline: B -&gt; NegTfm</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#2) [B:
encodes: (object,object) -&gt; encodes
decodes: ,NegTfm:
encodes: (object,object) -&gt; encodes
decodes: (object,object) -&gt; decodes
]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type='cpu')</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;__main__.TfmdDL at 0x7fda21023640&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Methods">
<a class="anchor" href="#Methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>Methods<a class="anchor-link" href="#Methods"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">TfmdDL</span><span class="o">.</span><span class="n">one_batch</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;function fastai.data.load.DataLoader.one_batch(self)&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfm</span> <span class="o">=</span> <span class="n">NegTfm</span><span class="p">()</span>
<span class="n">tdl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">tfm</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">tdl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">]),</span> <span class="n">b</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">TfmdDL</span><span class="o">.</span><span class="n">decode</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;function __main__.TfmdDL.decode(self, b)&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">TfmdDL</span><span class="o">.</span><span class="n">decode_batch</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;function __main__.TfmdDL.decode_batch(self, b, max_n=9, full=True)&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">decode_batch</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">TfmdDL</span><span class="o">.</span><span class="n">show_batch</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;function __main__.TfmdDL.show_batch(self, b=None, max_n=9, ctxs=None, show=True, unique=False, **kwargs)&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">TfmdDL</span><span class="o">.</span><span class="n">to</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;function __main__.TfmdDL.to(self, device)&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>此处的dataloaders不同于上一章节中的dataloader</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DataLoaders</span><span class="p">(</span><span class="n">GetAttr</span><span class="p">):</span>
    <span class="s2">"Basic wrapper around several `DataLoader`s."</span>
    <span class="n">_default</span><span class="o">=</span><span class="s1">'train'</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">loaders</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">'.'</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">loaders</span><span class="p">),</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">loaders</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'to'</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">new_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">loaders</span> <span class="o">=</span> <span class="p">[</span><span class="n">dl</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">new_empty</span><span class="p">())</span> <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="o">*</span><span class="n">loaders</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">train</span>   <span class="p">,</span><span class="n">valid</span>    <span class="o">=</span> <span class="n">add_props</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_set</span><span class="p">)</span>
    <span class="n">train_ds</span><span class="p">,</span><span class="n">valid_ds</span> <span class="o">=</span> <span class="n">add_props</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span>

    <span class="nd">@device</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">:</span> <span class="n">dl</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">default_device</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dsets</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">ds</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">'.'</span><span class="p">,</span>  <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="n">TfmdDL</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="kc">False</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'shuffle'</span><span class="p">:</span> <span class="n">default</span><span class="p">,</span> <span class="s1">'drop_last'</span><span class="p">:</span> <span class="n">default</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">_batch_tfms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">nm</span><span class="p">])</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">tuplify</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">range_of</span><span class="p">(</span><span class="n">ds</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">dl_type</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)],</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dblock</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dblock</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">'.'</span><span class="p">,</span>  <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">val_bs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">val_bs</span><span class="o">=</span><span class="n">val_bs</span><span class="p">,</span> <span class="n">shuffle_train</span><span class="o">=</span><span class="n">shuffle_train</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">_docs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="fm">__getitem__</span><span class="o">=</span><span class="s2">"Retrieve `DataLoader` at `i` (`0` is training, `1` is validation)"</span><span class="p">,</span>
               <span class="n">train</span><span class="o">=</span><span class="s2">"Training `DataLoader`"</span><span class="p">,</span>
               <span class="n">valid</span><span class="o">=</span><span class="s2">"Validation `DataLoader`"</span><span class="p">,</span>
               <span class="n">train_ds</span><span class="o">=</span><span class="s2">"Training `Dataset`"</span><span class="p">,</span>
               <span class="n">valid_ds</span><span class="o">=</span><span class="s2">"Validation `Dataset`"</span><span class="p">,</span>
               <span class="n">to</span><span class="o">=</span><span class="s2">"Use `device`"</span><span class="p">,</span>
               <span class="n">cuda</span><span class="o">=</span><span class="s2">"Use the gpu if available"</span><span class="p">,</span>
               <span class="n">cpu</span><span class="o">=</span><span class="s2">"Use the cpu"</span><span class="p">,</span>
               <span class="n">new_empty</span><span class="o">=</span><span class="s2">"Create a new empty version of `self` with the same transforms"</span><span class="p">,</span>
               <span class="n">from_dblock</span><span class="o">=</span><span class="s2">"Create a dataloaders from a given `dblock`"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tdl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([ 0, -1, -2, -3])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">DataLoaders</span><span class="p">(</span><span class="n">tdl</span><span class="p">,</span><span class="n">tdl</span><span class="p">)</span>
<span class="n">dls</span><span class="o">.</span><span class="n">train</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">x</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">first</span><span class="p">(</span><span class="n">tdl</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x2</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">x2</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;__main__.TfmdDL at 0x7fda0dfd81f0&gt;</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([ 0, -1, -2, -3])</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([ 0, -1, -2, -3])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#test assignment works</span>
<span class="n">dls</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">train</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;__main__.TfmdDL at 0x7fda212a89d0&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">train_ds</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,
        18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,
        36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">valid_ds</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,
        18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,
        36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49])</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Methods">
<a class="anchor" href="#Methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>Methods<a class="anchor-link" href="#Methods"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">DataLoaders</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DataLoaders.__getitem__" class="doc_header">
<a class="anchor" href="#DataLoaders.__getitem__" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>DataLoaders.__getitem__</code><a href="__main__.py#L10" class="source_link" style="float:right">[source]</a>
</h4>
<blockquote>
<p><code>DataLoaders.__getitem__</code>(<strong><code>i</code></strong>)</p>
</blockquote>
<p>Retrieve <a href="/data.load#DataLoader"><code>DataLoader</code></a> at <code>i</code> (<code>0</code> is training, <code>1</code> is validation)</p>

</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;__main__.TfmdDL at 0x7fda212a89d0&gt;</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;__main__.TfmdDL at 0x7fda0dfd81f0&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x2</span> <span class="o">=</span> <span class="n">dls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">FilteredBase</span><span class="p">:</span>
    <span class="s2">"Base class for lists with subsets"</span>
    <span class="n">_dl_type</span><span class="p">,</span><span class="n">_dbunch_type</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">,</span><span class="n">DataLoaders</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dl_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dl_type</span> <span class="o">=</span> <span class="n">dl_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span> <span class="o">=</span> <span class="n">delegates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dl_type</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_subsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">raise</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">dataloaders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">val_bs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">'.'</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dl_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">device</span><span class="o">=</span><span class="n">default_device</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dl_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dl_kwargs</span> <span class="o">=</span> <span class="p">[{}]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_subsets</span>
        <span class="k">if</span> <span class="n">dl_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dl_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dl_type</span>
        <span class="n">drop_last</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'drop_last'</span><span class="p">,</span> <span class="n">shuffle_train</span><span class="p">)</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">dl_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle_train</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="n">drop_last</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">merge</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">dl_kwargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">dls</span> <span class="o">=</span> <span class="p">[</span><span class="n">dl</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dl</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">bs</span><span class="o">=</span><span class="p">(</span><span class="n">bs</span> <span class="k">if</span> <span class="n">val_bs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val_bs</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">dl_kwargs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_subsets</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbunch_type</span><span class="p">(</span><span class="o">*</span><span class="n">dls</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">FilteredBase</span><span class="o">.</span><span class="n">train</span><span class="p">,</span><span class="n">FilteredBase</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="n">add_props</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TfmdLists</span><span class="p">(</span><span class="n">FilteredBase</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">GetAttr</span><span class="p">):</span>
    <span class="s2">"A `Pipeline` of `tfms` applied to a collection of `items`"</span>
    <span class="n">_default</span><span class="o">=</span><span class="s1">'tfms'</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">tfms</span><span class="p">,</span> <span class="n">use_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">splits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">use_list</span><span class="o">=</span><span class="n">use_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dl_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dl_type</span> <span class="o">=</span> <span class="n">dl_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="n">L</span><span class="p">([</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),[]]</span> <span class="k">if</span> <span class="n">splits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">splits</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mask2idxs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tfms</span><span class="p">,</span><span class="n">TfmdLists</span><span class="p">):</span> <span class="n">tfms</span> <span class="o">=</span> <span class="n">tfms</span><span class="o">.</span><span class="n">tfms</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tfms</span><span class="p">,</span><span class="n">Pipeline</span><span class="p">):</span> <span class="n">do_setup</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tfms</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">tfms</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="n">split_idx</span><span class="p">)</span>
        <span class="n">store_attr</span><span class="p">(</span><span class="s1">'types,split_idx'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_setup</span><span class="p">:</span>
            <span class="n">pv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Setting up </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">train_setup</span><span class="o">=</span><span class="n">train_setup</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="n">ifnone</span><span class="p">(</span><span class="n">split_idx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="p">,</span> <span class="n">do_setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="n">split_idx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">split_idx</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_after_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="si">}</span><span class="se">\n</span><span class="s2">tfms - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">fs</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">overlapping_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">concat</span><span class="p">())</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">gt</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">new_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">([])</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_setup</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">fs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">'input_types'</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">types</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">t</span> <span class="k">if</span> <span class="n">is_listy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">)</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretty_types</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">'  - </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">infer_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># TODO: check if we really need this, or can simplify</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="k">break</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">types</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">t</span> <span class="k">if</span> <span class="n">is_listy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">)</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">pretty_types</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">'  - </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Expected an input of type in </span><span class="se">\n</span><span class="si">{</span><span class="n">pretty_types</span><span class="si">}</span><span class="se">\n</span><span class="s2"> but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="n">idx</span>

    <span class="k">def</span> <span class="nf">infer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">compose_tfms</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">infer_idx</span><span class="p">(</span><span class="n">x</span><span class="p">):],</span> <span class="n">split_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_after_item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_after_item</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_indexer</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">else</span> <span class="n">res</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_after_item</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>(TfmdLists,
         setup="Transform setup with self",
         decode="From <code>Pipeline</code>",
         show="From <code>Pipeline</code>",
         overlapping_splits="All splits that are in more than one split",
         subset="New <code>TfmdLists</code> with same tfms that only includes items in <code>i</code>th split",
         infer_idx="Finds the index where <code>self.tfms</code> can be applied to <code>x</code>, depending on the type of <code>x</code>",
         infer="Apply <code>self.tfms</code> to <code>x</code> starting at the right tfm depending on the type of <code>x</code>",
         new_empty="A new version of <code>self</code> but with no items")</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">decode_at</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="s2">"Decoded item at `idx`"</span>
    <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">show_at</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s2">"Show item at `idx`"</span><span class="p">,</span>
    <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A <code>TfmdLists</code> combines a collection of object with a <code>Pipeline</code>. <code>tfms</code> can either be a <code>Pipeline</code> or a list of transforms, in which case, it will wrap them in a <code>Pipeline</code>. <code>use_list</code> is passed along to <code>L</code> with the <code>items</code> and <code>split_idx</code> are passed to each transform of the <code>Pipeline</code>. <code>do_setup</code> indicates if the <code>Pipeline.setup</code> method should be called during initialization.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>TitledInt<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">_IntFloatTfm</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>  <span class="k">return</span> <span class="n">TitledInt</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>  <span class="k">return</span> <span class="n">TitledFloat</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="n">int2f_tfm</span><span class="o">=</span><span class="n">_IntFloatTfm</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_neg</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="n">o</span>
<span class="n">neg_tfm</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span><span class="n">_neg</span><span class="p">,</span> <span class="n">_neg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">aa</span> <span class="o">=</span> <span class="n">neg_tfm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">aa</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>-2</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">items</span> <span class="o">=</span> <span class="n">L</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">3.</span><span class="p">]);</span> <span class="n">tfms</span> <span class="o">=</span> <span class="p">[</span><span class="n">neg_tfm</span><span class="p">,</span> <span class="n">int2f_tfm</span><span class="p">]</span>
<span class="n">tl</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="n">tfms</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">tl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TitledInt</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">tl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TitledInt</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">tl</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">TitledFloat</span><span class="p">(</span><span class="mf">3.</span><span class="p">))</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">show_at</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">'-3'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">types</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">TitledInt</span><span class="p">])</span>
<span class="n">tl</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TfmdLists: [1.0, 2.0, 3.0]
tfms - [_neg:
encodes: (object,object) -&gt; _negdecodes: (object,object) -&gt; _neg, _IntFloatTfm:
encodes: (object,object) -&gt; encodes
decodes: (object,object) -&gt; decodes
]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># add splits to TfmdLists</span>
<span class="n">splits</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">tl</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="n">tfms</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">n_subsets</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="n">tl</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">valid</span><span class="p">,</span> <span class="n">tl</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">split_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">split_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">new_empty</span><span class="p">()</span><span class="o">.</span><span class="n">split_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">new_empty</span><span class="p">()</span><span class="o">.</span><span class="n">split_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">splits</span><span class="p">,</span> <span class="n">L</span><span class="p">(</span><span class="n">splits</span><span class="p">))</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">tl</span><span class="o">.</span><span class="n">overlapping_splits</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="n">b</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]))</span>
<span class="n">tl</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">tr</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tr</span><span class="p">[:],</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">val</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">val</span><span class="p">[:],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">items</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#3) [1.0,2.0,3.0]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">_B</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">o</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">o</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span>
    <span class="k">def</span> <span class="nf">setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span> 
        <span class="nb">print</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="c1"># test for setup, which updates `self.m`</span>
<span class="n">tl</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">_B</span><span class="p">())</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>TfmdLists: [1.0, 2.0, 3.0]
tfms - []
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here's how we can use <code>TfmdLists.setup</code> to implement a simple category list, getting labels from a mock file list:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">_Cat</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o2i</span><span class="p">[</span><span class="n">o</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>    <span class="k">return</span> <span class="n">TitledStr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">o</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">o2i</span> <span class="o">=</span> <span class="n">uniqueify</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bidir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tcat</span> <span class="o">=</span> <span class="n">_Cat</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_lbl</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">TitledStr</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Check that tfms are sorted by `order` &amp; `_lbl` is called first</span>
<span class="n">fns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'dog_0.jpg'</span><span class="p">,</span><span class="s1">'cat_0.jpg'</span><span class="p">,</span><span class="s1">'cat_2.jpg'</span><span class="p">,</span><span class="s1">'cat_1.jpg'</span><span class="p">,</span><span class="s1">'dog_1.jpg'</span><span class="p">]</span>
<span class="n">tl</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="p">[</span><span class="n">tcat</span><span class="p">,</span><span class="n">_lbl</span><span class="p">])</span>
<span class="n">exp_voc</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'cat'</span><span class="p">,</span><span class="s1">'dog'</span><span class="p">]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tcat</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="n">exp_voc</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="n">exp_voc</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="n">exp_voc</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">([</span><span class="n">tl</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">tl</span><span class="p">],</span> <span class="p">(</span><span class="s1">'dog'</span><span class="p">,</span><span class="s1">'cat'</span><span class="p">,</span><span class="s1">'cat'</span><span class="p">,</span><span class="s1">'cat'</span><span class="p">,</span><span class="s1">'dog'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Check only the training set is taken into account for setup</span>
<span class="n">tl</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="p">[</span><span class="n">tcat</span><span class="p">,</span><span class="n">_lbl</span><span class="p">],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tcat</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="p">[</span><span class="s1">'dog'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfm</span> <span class="o">=</span> <span class="n">NegTfm</span><span class="p">(</span><span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">tds</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">A</span><span class="p">())</span>
<span class="n">tdl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">(</span><span class="n">tds</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">tfm</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tdl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">tds</span><span class="o">.</span><span class="n">split_idx</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tdl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">tds</span><span class="o">.</span><span class="n">split_idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tdl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tds</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">A</span><span class="p">())</span>
<span class="n">tdl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">(</span><span class="n">tds</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">NegTfm</span><span class="p">(),</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tdl</span><span class="p">),</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tds</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">show_batch</span><span class="p">,</span> <span class="s1">'0</span><span class="se">\n</span><span class="s1">1</span><span class="se">\n</span><span class="s1">2</span><span class="se">\n</span><span class="s1">3'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">TfmdLists</span><span class="o">.</span><span class="n">subset</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;function __main__.TfmdLists.subset(self, i)&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">TfmdLists</span><span class="o">.</span><span class="n">infer_idx</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;function __main__.TfmdLists.infer_idx(self, x)&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">TfmdLists</span><span class="o">.</span><span class="n">infer</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;function __main__.TfmdLists.infer(self, x)&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">mult</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span>
<span class="n">mult</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">fns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'dog_0.jpg'</span><span class="p">,</span><span class="s1">'cat_0.jpg'</span><span class="p">,</span><span class="s1">'cat_2.jpg'</span><span class="p">,</span><span class="s1">'cat_1.jpg'</span><span class="p">,</span><span class="s1">'dog_1.jpg'</span><span class="p">]</span>
<span class="n">tl</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="p">[</span><span class="n">_lbl</span><span class="p">,</span><span class="n">_Cat</span><span class="p">(),</span><span class="n">mult</span><span class="p">])</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">infer_idx</span><span class="p">(</span><span class="s1">'dog_45.jpg'</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="s1">'dog_45.jpg'</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">infer_idx</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>

<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">infer_idx</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Test input_types works on a Transform</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">_Cat</span><span class="p">()</span>
<span class="n">cat</span><span class="o">.</span><span class="n">input_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">tl</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="p">[</span><span class="n">_lbl</span><span class="p">,</span><span class="n">cat</span><span class="p">,</span><span class="n">mult</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">infer_idx</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1">#Test type annotations work on a function</span>
<span class="k">def</span> <span class="nf">mult</span><span class="p">(</span><span class="n">x</span><span class="p">:(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span>
<span class="n">mult</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">tl</span> <span class="o">=</span> <span class="n">TfmdLists</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="p">[</span><span class="n">_lbl</span><span class="p">,</span><span class="n">_Cat</span><span class="p">(),</span><span class="n">mult</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">infer_idx</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@delegates</span><span class="p">(</span><span class="n">TfmdLists</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Datasets</span><span class="p">(</span><span class="n">FilteredBase</span><span class="p">):</span>
    <span class="s2">"A dataset that creates a tuple from each `tfms`, passed through `item_tfms`"</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dl_type</span><span class="o">=</span><span class="n">dl_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tls</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">tls</span> <span class="k">if</span> <span class="n">tls</span> <span class="k">else</span> <span class="p">[</span><span class="n">TfmdLists</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">L</span><span class="p">(</span><span class="n">ifnone</span><span class="p">(</span><span class="n">tfms</span><span class="p">,[</span><span class="kc">None</span><span class="p">]))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_inp</span> <span class="o">=</span> <span class="n">ifnone</span><span class="p">(</span><span class="n">n_inp</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">tl</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="n">is_indexer</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span> <span class="k">return</span> <span class="n">gather_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s1">'tls'</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">()</span> <span class="o">+</span> <span class="n">gather_attr_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'tls'</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">coll_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">o_</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">)</span> <span class="k">for</span> <span class="n">o_</span><span class="p">,</span><span class="n">tl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">tuplify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">o</span><span class="p">)))</span>
    <span class="k">def</span> <span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">tls</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">),</span> <span class="n">n_inp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inp</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tfms</span><span class="p">,</span> <span class="n">do_setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">overlapping_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">overlapping_splits</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">new_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">tls</span><span class="o">=</span><span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">new_empty</span><span class="p">()</span> <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">],</span> <span class="n">n_inp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inp</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">splits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">splits</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">split_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">split_idx</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span>
    <span class="nd">@items</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">o_</span><span class="p">,</span><span class="n">tl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">):</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">o_</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">set_split_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">old_split_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span>
        <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">split_idx</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">yield</span> <span class="bp">self</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">split_idx</span> <span class="o">=</span> <span class="n">old_split_idx</span>

    <span class="n">_docs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">decode</span><span class="o">=</span><span class="s2">"Compose `decode` of all `tuple_tfms` then all `tfms` on `i`"</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="s2">"Show item `o` in `ctx`"</span><span class="p">,</span>
        <span class="n">dataloaders</span><span class="o">=</span><span class="s2">"Get a `DataLoaders`"</span><span class="p">,</span>
        <span class="n">overlapping_splits</span><span class="o">=</span><span class="s2">"All splits that are in more than one split"</span><span class="p">,</span>
        <span class="n">subset</span><span class="o">=</span><span class="s2">"New `Datasets` that only includes subset `i`"</span><span class="p">,</span>
        <span class="n">new_empty</span><span class="o">=</span><span class="s2">"Create a new empty version of the `self`, keeping only the transforms"</span><span class="p">,</span>
        <span class="n">set_split_idx</span><span class="o">=</span><span class="s2">"Contextmanager to use the same `Datasets` with another `split_idx`"</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A <code>Datasets</code> creates a tuple from <code>items</code> (typically input,target) by applying to them each list of <code>Transform</code> (or <code>Pipeline</code>) in <code>tfms</code>. Note that if <code>tfms</code> contains only one list of <code>tfms</code>, the items given by <code>Datasets</code> will be tuples of one element.</p>
<p><code>n_inp</code> is the number of elements in the tuples that should be considered part of the input and will default to 1 if <code>tfms</code> consists of one set of transforms, <code>len(tfms)-1</code> otherwise. In most cases, the number of elements in the tuples spit out by <code>Datasets</code> will be 2 (for input,target) but it can happen that there is 3 (Siamese networks or tabular data) in which case we need to be able to determine when the inputs end and the targets begin.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;function fastcore.basics._oper.&lt;locals&gt;.&lt;lambda&gt;(o)&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">items</span> <span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="c1"># 下面定义了两组变换形式, 求负数与类型转换+加一的操作</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">[[</span><span class="n">neg_tfm</span><span class="p">,</span><span class="n">int2f_tfm</span><span class="p">],</span> <span class="p">[</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)]])</span>
<span class="n">dsets</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">n_inp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">dsets</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#4) [(-1, 2),(-2, 3),(-3, 4),(-4, 5)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(1.0, 2)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Norm变换example">
<a class="anchor" href="#Norm%E5%8F%98%E6%8D%A2example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Norm变换example<a class="anchor-link" href="#Norm%E5%8F%98%E6%8D%A2example"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Norm</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">o</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">o</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span>
    <span class="k">def</span> <span class="nf">setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="n">its</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">its</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">its</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">nrm</span> <span class="o">=</span> <span class="n">Norm</span><span class="p">()</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">[[</span><span class="n">neg_tfm</span><span class="p">,</span><span class="n">int2f_tfm</span><span class="p">],</span> <span class="p">[</span><span class="n">neg_tfm</span><span class="p">,</span><span class="n">nrm</span><span class="p">]])</span>

<span class="n">dsets</span>
<span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">dsets</span><span class="p">)</span>
<span class="n">x</span>
<span class="n">y</span>
<span class="c1"># 实行变换后,可以直接从子类中取出mean这个属性值</span>
<span class="n">nrm</span><span class="o">.</span><span class="n">m</span>


<span class="n">test_close</span><span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">test_close</span><span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">,))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">nrm</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">show_at</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">'-2'</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">nrm</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">nrm</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">nrm</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#4) [(-1, tensor(1.1619)),(-2, tensor(0.3873)),(-3, tensor(-0.3873)),(-4, tensor(-1.1619))]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(-1, -2, -3, -4)</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor(1.1619), tensor(0.3873), tensor(-0.3873), tensor(-1.1619))</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(-2.5000)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Check filtering is properly applied</span>
<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>  <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>        <span class="k">return</span> <span class="n">TitledInt</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">add1</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">[</span><span class="n">neg_tfm</span><span class="p">,</span> <span class="p">[</span><span class="n">neg_tfm</span><span class="p">,</span><span class="n">int2f_tfm</span><span class="p">,</span><span class="n">add1</span><span class="p">]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">3</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_Cat</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>_Cat:
encodes: (object,object) -&gt; encodes
decodes: (object,object) -&gt; decodes</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_fns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'dog_0.jpg'</span><span class="p">,</span><span class="s1">'cat_0.jpg'</span><span class="p">,</span><span class="s1">'cat_2.jpg'</span><span class="p">,</span><span class="s1">'cat_1.jpg'</span><span class="p">,</span><span class="s1">'kid_1.jpg'</span><span class="p">]</span>
<span class="n">tcat</span> <span class="o">=</span> <span class="n">_Cat</span><span class="p">()</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">test_fns</span><span class="p">,</span> <span class="p">[[</span><span class="n">tcat</span><span class="p">,</span><span class="n">_lbl</span><span class="p">]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]])</span>

<span class="n">dsets</span><span class="o">.</span><span class="n">train</span>
<span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">tcat</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="p">[</span><span class="s1">'cat'</span><span class="p">,</span><span class="s1">'dog'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">0</span><span class="p">,),(</span><span class="mi">0</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">show_at</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">"dog"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#3) [(1,),(0,),(0,)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(0,)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span>

<span class="n">dsets</span>
<span class="n">dsets</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">test_eq</span><span class="p">(</span><span class="o">*</span><span class="n">dsets</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>          <span class="c1"># Retrieve one item (subset 0 is the default)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">2</span><span class="p">,)])</span>    <span class="c1"># Retrieve two items by index</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,),(</span><span class="mi">3</span><span class="p">,)])</span>   <span class="c1"># Retrieve two items by mask</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(0,),(1,),(2,),(3,),(4,)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2,)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]))</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">inp</span>
<span class="n">dsets</span>


<span class="n">test_eq</span><span class="p">(</span><span class="o">*</span><span class="n">dsets</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>          <span class="c1"># Retrieve one item (subset 0 is the default)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">2</span><span class="p">,)])</span>    <span class="c1"># Retrieve two items by index</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="p">[(</span><span class="mi">5</span><span class="p">,),(</span><span class="mi">3</span><span class="p">,)])</span>   <span class="c1"># Retrieve two items by mask</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(5,),(1,),(2,),(3,),(4,)]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#test n_inp</span>
<span class="n">inp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
<span class="n">dsets</span>
<span class="n">dsets</span><span class="o">.</span><span class="n">n_inp</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span>

<span class="n">dsets</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">n_inp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[[</span><span class="kc">None</span><span class="p">],[</span><span class="kc">None</span><span class="p">],[</span><span class="kc">None</span><span class="p">]])</span>

<span class="n">dsets</span>


<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">n_inp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[[</span><span class="kc">None</span><span class="p">],[</span><span class="kc">None</span><span class="p">]])</span>
<span class="n">dsets</span>
<span class="n">dsets</span><span class="o">.</span><span class="n">n_inp</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[[</span><span class="kc">None</span><span class="p">],[</span><span class="kc">None</span><span class="p">],[</span><span class="kc">None</span><span class="p">]],</span> <span class="n">n_inp</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">dsets</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">n_inp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(0,),(1,),(2,),(3,),(4,)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(0,),(1,),(2,),(3,),(4,)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(0, 0, 0),(1, 1, 1),(2, 2, 2),(3, 3, 3),(4, 4, 4)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(0, 0),(1, 1),(2, 2),(3, 3),(4, 4)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(0, 0, 0),(1, 1, 1),(2, 2, 2),(3, 3, 3),(4, 4, 4)]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># splits can be indices</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]])</span>
<span class="c1"># dsets</span>
<span class="n">dsets</span><span class="o">.</span><span class="n">train</span>
<span class="n">dsets</span><span class="o">.</span><span class="n">valid</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,),(</span><span class="mi">2</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,),(</span><span class="mi">2</span><span class="p">,)])</span>       <span class="c1"># Subset 0 is aliased to `train`</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">3</span><span class="p">,),(</span><span class="mi">4</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">,</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">3</span><span class="p">,),(</span><span class="mi">4</span><span class="p">,)])</span>     <span class="c1"># Subset 1 is aliased to `valid`</span>
<span class="n">test_eq</span><span class="p">(</span><span class="o">*</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
<span class="c1">#assert '[(1,),(3,),(4,)]' in str(dsets) and '[(0,),(2,)]' in str(dsets)</span>
<span class="c1"># dsets</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#2) [(0,),(2,)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#3) [(1,),(3,),(4,)]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># splits can be boolean masks (they don't have to cover all items, but must be disjoint)</span>
<span class="n">splits</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">],</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">]]</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">2</span><span class="p">,),(</span><span class="mi">4</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">,</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># apply transforms to all items</span>
<span class="n">tfm</span> <span class="o">=</span> <span class="p">[[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">splits</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]]</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">tfm</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">)</span>
<span class="n">dsets</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,[(</span><span class="mi">3</span><span class="p">,),(</span><span class="mi">5</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">,[(</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">7</span><span class="p">,),(</span><span class="mi">9</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">],</span> <span class="p">[(</span><span class="mi">5</span><span class="p">,)])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(1,),(3,),(5,),(7,),(9,)]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://i.loli.net/2021/01/31/FsWpz2ImgnHyU9a.png" alt=""></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># only transform subset 1</span>
<span class="k">class</span> <span class="nc">_Tfm</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">TitledStr</span><span class="p">(</span><span class="n">x</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">aa</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">bs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="n">after_item</span><span class="o">=</span><span class="n">_Tfm</span><span class="p">())</span>
<span class="n">L</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#3) [tensor([0, 1]),tensor([2, 3]),tensor([4])]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="p">[</span><span class="n">_Tfm</span><span class="p">()])</span>
<span class="n">dsets</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(0,),(1,),(2,),(3,),(4,)]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="p">[</span><span class="n">_Tfm</span><span class="p">()],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]])</span>
<span class="n">dsets</span>
<span class="c1"># 注意此处的dsets没有发生转换, 反而单独拿出来valid有了变化</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,[(</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">2</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">,[(</span><span class="mi">0</span><span class="p">,),(</span><span class="mi">6</span><span class="p">,),(</span><span class="mi">8</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">],</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,)])</span>
<span class="n">dsets</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(0,),(1,),(2,),(3,),(4,)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(0,),(1,),(2,),(3,),(4,)]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#A context manager to change the split_idx and apply the validation transform on the training set</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">train</span>
<span class="n">ds</span>
<span class="k">with</span> <span class="n">ds</span><span class="o">.</span><span class="n">set_split_idx</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">ds</span><span class="p">,[(</span><span class="mi">2</span><span class="p">,),(</span><span class="mi">4</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,[(</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">2</span><span class="p">,)])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#2) [(1,),(2,)]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Test Datasets pickles</span>
<span class="n">dsrc1</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="n">dsrc1</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">,</span> <span class="n">dsrc1</span><span class="o">.</span><span class="n">valid</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="p">[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">noop</span><span class="p">],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]])</span>
<span class="n">dsets</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">,[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">)])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [(0, 0),(1, 1),(2, 2),(3, 3),(4, 4)]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>
<span class="n">tds</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="p">[</span><span class="n">A</span><span class="p">()])</span>
<span class="n">tdl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">(</span><span class="n">tds</span><span class="p">,</span> <span class="n">after_item</span><span class="o">=</span><span class="n">NegTfm</span><span class="p">(),</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">tdl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">decode_batch</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="p">((</span><span class="mi">0</span><span class="p">,),(</span><span class="mi">1</span><span class="p">,),(</span><span class="mi">2</span><span class="p">,),(</span><span class="mi">3</span><span class="p">,)))</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="n">tdl</span><span class="o">.</span><span class="n">show_batch</span><span class="p">,</span> <span class="s2">"0</span><span class="se">\n</span><span class="s2">1</span><span class="se">\n</span><span class="s2">2</span><span class="se">\n</span><span class="s2">3"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># only transform subset 1</span>
<span class="k">class</span> <span class="nc">_Tfm</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span>

    
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">dsets</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),[</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">dsets</span>

<span class="n">dsets</span><span class="o">.</span><span class="n">valid</span>
<span class="n">dsets</span><span class="o">.</span><span class="n">train</span>
<span class="n">dsets</span><span class="o">.</span><span class="n">n_inp</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#8) [(0,),(1,),(2,),(3,),(4,),(5,),(6,),(7,)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#8) [(0, 0, 0),(1, 1, 1),(2, 2, 2),(3, 3, 3),(4, 4, 4),(5, 5, 5),(6, 6, 6),(7, 7, 7)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#4) [(0, 0, 0),(3, 3, 3),(4, 4, 4),(6, 6, 6)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#4) [(1, 1, 1),(2, 2, 2),(5, 5, 5),(7, 7, 7)]</pre>
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>2</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># only transform subset 1</span>
<span class="k">class</span> <span class="nc">_Tfm</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">_Tfm</span><span class="p">(),</span> <span class="n">shuffle_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="p">[(</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">valid</span><span class="p">,</span> <span class="p">[(</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">]),)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">n_inp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Methods">
<a class="anchor" href="#Methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>Methods<a class="anchor-link" href="#Methods"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">[[</span><span class="n">neg_tfm</span><span class="p">,</span><span class="n">int2f_tfm</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_dsrc</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="p">(</span><span class="n">_dsrc</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"Datasets.dataloaders"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Datasets.dataloaders" class="doc_header">
<a class="anchor" href="#Datasets.dataloaders" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>Datasets.dataloaders</code><a href="__main__.py#L15" class="source_link" style="float:right">[source]</a>
</h4>
<blockquote>
<p><code>Datasets.dataloaders</code>(<strong><code>bs</code></strong>=<em><code>64</code></em>, <strong><code>val_bs</code></strong>=<em><code>None</code></em>, <strong><code>shuffle_train</code></strong>=<em><code>True</code></em>, <strong><code>n</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>'.'</code></em>, <strong><code>dl_type</code></strong>=<em><code>None</code></em>, <strong><code>dl_kwargs</code></strong>=<em><code>None</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>, <strong><code>shuffle</code></strong>=<em><code>False</code></em>, <strong><code>num_workers</code></strong>=<em><code>None</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>, <strong><code>do_setup</code></strong>=<em><code>True</code></em>, <strong><code>pin_memory</code></strong>=<em><code>False</code></em>, <strong><code>timeout</code></strong>=<em><code>0</code></em>, <strong><code>batch_size</code></strong>=<em><code>None</code></em>, <strong><code>drop_last</code></strong>=<em><code>False</code></em>, <strong><code>indexed</code></strong>=<em><code>None</code></em>, <strong><code>persistent_workers</code></strong>=<em><code>False</code></em>, <strong><code>wif</code></strong>=<em><code>None</code></em>, <strong><code>before_iter</code></strong>=<em><code>None</code></em>, <strong><code>after_item</code></strong>=<em><code>None</code></em>, <strong><code>before_batch</code></strong>=<em><code>None</code></em>, <strong><code>after_batch</code></strong>=<em><code>None</code></em>, <strong><code>after_iter</code></strong>=<em><code>None</code></em>, <strong><code>create_batches</code></strong>=<em><code>None</code></em>, <strong><code>create_item</code></strong>=<em><code>None</code></em>, <strong><code>create_batch</code></strong>=<em><code>None</code></em>, <strong><code>retain</code></strong>=<em><code>None</code></em>, <strong><code>get_idxs</code></strong>=<em><code>None</code></em>, <strong><code>sample</code></strong>=<em><code>None</code></em>, <strong><code>shuffle_fn</code></strong>=<em><code>None</code></em>, <strong><code>do_batch</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Get a <a href="/data.core#DataLoaders"><code>DataLoaders</code></a></p>

</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">Datasets</span><span class="o">.</span><span class="n">decode</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Datasets.decode" class="doc_header">
<a class="anchor" href="#Datasets.decode" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>Datasets.decode</code><a href="__main__.py#L20" class="source_link" style="float:right">[source]</a>
</h4>
<blockquote>
<p><code>Datasets.decode</code>(<strong><code>o</code></strong>, <strong><code>full</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Compose <code>decode</code> of all <code>tuple_tfms</code> then all <code>tfms</code> on <code>i</code></p>

</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="o">*</span><span class="n">dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="o">*</span><span class="n">dsets</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,)),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">Datasets</span><span class="o">.</span><span class="n">show</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Datasets.show" class="doc_header">
<a class="anchor" href="#Datasets.show" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>Datasets.show</code><a href="__main__.py#L35" class="source_link" style="float:right">[source]</a>
</h4>
<blockquote>
<p><code>Datasets.show</code>(<strong><code>o</code></strong>, <strong><code>ctx</code></strong>=<em><code>None</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>Show item <code>o</code> in <code>ctx</code></p>

</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">dsets</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">'-2'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">Datasets</span><span class="o">.</span><span class="n">new_empty</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Datasets.new_empty" class="doc_header">
<a class="anchor" href="#Datasets.new_empty" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>Datasets.new_empty</code><a href="__main__.py#L24" class="source_link" style="float:right">[source]</a>
</h4>
<blockquote>
<p><code>Datasets.new_empty</code>()</p>
</blockquote>
<p>Create a new empty version of the <code>self</code>, keeping only the transforms</p>

</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">nrm</span> <span class="o">=</span> <span class="n">Norm</span><span class="p">()</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">[[</span><span class="n">neg_tfm</span><span class="p">,</span><span class="n">int2f_tfm</span><span class="p">],</span> <span class="p">[</span><span class="n">neg_tfm</span><span class="p">]])</span>
<span class="n">empty</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">new_empty</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">empty</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="p">[])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#test it works for dataframes too</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'a'</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="s1">'b'</span><span class="p">:[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">]})</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)],</span> <span class="p">[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">'b'</span><span class="p">)]])</span>
<span class="n">empty</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">new_empty</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Add-test-set-for-inference">
<a class="anchor" href="#Add-test-set-for-inference" aria-hidden="true"><span class="octicon octicon-link"></span></a>Add test set for inference<a class="anchor-link" href="#Add-test-set-for-inference"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># only transform subset 1</span>
<span class="k">class</span> <span class="nc">_Tfm1</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="n">split_idx</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">3</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">[[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm1</span><span class="p">()]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,),(</span><span class="mi">6</span><span class="p">,),(</span><span class="mi">15</span><span class="p">,),(</span><span class="mi">21</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">,</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,),(</span><span class="mi">6</span><span class="p">,),(</span><span class="mi">8</span><span class="p">,),(</span><span class="mi">12</span><span class="p">,)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_set</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">test_items</span><span class="p">,</span> <span class="n">rm_tfms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="s2">"Create a test set from `test_items` using validation transforms of `dsets`"</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">Datasets</span><span class="p">):</span>
        <span class="n">tls</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">tls</span> <span class="k">if</span> <span class="n">with_labels</span> <span class="k">else</span> <span class="n">dsets</span><span class="o">.</span><span class="n">tls</span><span class="p">[:</span><span class="n">dsets</span><span class="o">.</span><span class="n">n_inp</span><span class="p">]</span>
        <span class="n">test_tls</span> <span class="o">=</span> <span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">test_items</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">tls</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rm_tfms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rm_tfms</span> <span class="o">=</span> <span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">infer_idx</span><span class="p">(</span><span class="n">get_first</span><span class="p">(</span><span class="n">test_items</span><span class="p">))</span> <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">test_tls</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>               <span class="n">rm_tfms</span> <span class="o">=</span> <span class="n">tuplify</span><span class="p">(</span><span class="n">rm_tfms</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">test_tls</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rm_tfms</span><span class="p">):</span> <span class="n">test_tls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">test_tls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">tls</span><span class="o">=</span><span class="n">test_tls</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">TfmdLists</span><span class="p">):</span>
        <span class="n">test_tl</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">test_items</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rm_tfms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">rm_tfms</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">infer_idx</span><span class="p">(</span><span class="n">get_first</span><span class="p">(</span><span class="n">test_items</span><span class="p">))</span>
        <span class="n">test_tl</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">test_tl</span><span class="o">.</span><span class="n">tfms</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">rm_tfms</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">test_tl</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"This method requires using the fastai library to assemble your data. Expected a `Datasets` or a `TfmdLists` but got </span><span class="si">{</span><span class="n">dsets</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">_Tfm1</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="n">split_idx</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">3</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">[[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm1</span><span class="p">()]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,),(</span><span class="mi">6</span><span class="p">,),(</span><span class="mi">15</span><span class="p">,),(</span><span class="mi">21</span><span class="p">,)])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">valid</span><span class="p">,</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,),(</span><span class="mi">6</span><span class="p">,),(</span><span class="mi">8</span><span class="p">,),(</span><span class="mi">12</span><span class="p">,)])</span>

<span class="c1">#Tranform of the validation set are applied</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">test_set</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,),(</span><span class="mi">4</span><span class="p">,),(</span><span class="mi">6</span><span class="p">,)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Test with different types</span>
<span class="n">tfm</span> <span class="o">=</span> <span class="n">_Tfm1</span><span class="p">()</span>
<span class="n">tfm</span><span class="o">.</span><span class="n">split_idx</span><span class="p">,</span><span class="n">tfm</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="mi">2</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">([</span><span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">],</span> <span class="p">[[</span><span class="n">_Cat</span><span class="p">(),</span><span class="n">tfm</span><span class="p">]])</span>

<span class="c1">#With strings</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">test_set</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="p">[</span><span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">]),</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)])</span>
<span class="c1">#With ints</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">test_set</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Test with various input lengths</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">[[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm1</span><span class="p">()],[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm1</span><span class="p">()],[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm1</span><span class="p">()]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">test_set</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)])</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">[[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm1</span><span class="p">()],[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm1</span><span class="p">()],[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm1</span><span class="p">()]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]],</span> <span class="n">n_inp</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">test_set</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,),(</span><span class="mi">4</span><span class="p">,),(</span><span class="mi">6</span><span class="p">,)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Test with rm_tfms</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">[[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm</span><span class="p">()]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">test_set</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="p">[(</span><span class="mi">4</span><span class="p">,),(</span><span class="mi">8</span><span class="p">,),(</span><span class="mi">12</span><span class="p">,)])</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">[[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm</span><span class="p">()]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">test_set</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">rm_tfms</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,),(</span><span class="mi">4</span><span class="p">,),(</span><span class="mi">6</span><span class="p">,)])</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">[[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm</span><span class="p">()],</span> <span class="p">[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm</span><span class="p">()]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]],</span> <span class="n">n_inp</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">test_set</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">rm_tfms</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">),(</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@patch</span>
<span class="nd">@delegates</span><span class="p">(</span><span class="n">TfmdDL</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_dl</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span><span class="n">DataLoaders</span><span class="p">,</span> <span class="n">test_items</span><span class="p">,</span> <span class="n">rm_type_tfms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s2">"Create a test dataloader from `test_items` using validation transforms of `dls`"</span>
    <span class="n">test_ds</span> <span class="o">=</span> <span class="n">test_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_ds</span><span class="p">,</span> <span class="n">test_items</span><span class="p">,</span> <span class="n">rm_tfms</span><span class="o">=</span><span class="n">rm_type_tfms</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="n">with_labels</span>
                      <span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_ds</span><span class="p">,</span> <span class="p">(</span><span class="n">Datasets</span><span class="p">,</span> <span class="n">TfmdLists</span><span class="p">))</span> <span class="k">else</span> <span class="n">test_items</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">test_ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">[[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm1</span><span class="p">()]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">[[</span><span class="n">_Tfm</span><span class="p">(),</span><span class="n">_Tfm1</span><span class="p">()]],</span> <span class="n">splits</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">dsets</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">))</span>
<span class="n">tst_dl</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tst_dl</span><span class="o">.</span><span class="n">_n_inp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tst_dl</span><span class="p">),</span> <span class="p">[(</span><span class="n">tensor</span><span class="p">([</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">]),)])</span>
<span class="c1">#Test you can change transforms</span>
<span class="n">tst_dl</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">after_item</span><span class="o">=</span><span class="n">add1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tst_dl</span><span class="p">),</span> <span class="p">[(</span><span class="n">tensor</span><span class="p">([</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">]),)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="bowenroom/myBlog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/myBlog/pytorch/fastai/2021/01/31/fastai-datacore.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/myBlog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/myBlog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/myBlog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>learn DL easily</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/bowenroom" title="bowenroom"><svg class="svg-icon grey"><use xlink:href="/myBlog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/bowenroom1" title="bowenroom1"><svg class="svg-icon grey"><use xlink:href="/myBlog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
