<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>fastai data transform | Bowenroom</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="fastai data transform" />
<meta name="author" content="Bowen" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="borrow code from https://docs.fast.ai/data.transforms.html and add some tips" />
<meta property="og:description" content="borrow code from https://docs.fast.ai/data.transforms.html and add some tips" />
<link rel="canonical" href="https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-data-transform.html" />
<meta property="og:url" content="https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-data-transform.html" />
<meta property="og:site_name" content="Bowenroom" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-31T00:00:00-06:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Bowen"},"description":"borrow code from https://docs.fast.ai/data.transforms.html and add some tips","@type":"BlogPosting","headline":"fastai data transform","dateModified":"2021-01-31T00:00:00-06:00","datePublished":"2021-01-31T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-data-transform.html"},"url":"https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-data-transform.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/myBlog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://bowenroom.github.io/myBlog/feed.xml" title="Bowenroom" /><link rel="shortcut icon" type="image/x-icon" href="/myBlog/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>fastai data transform | Bowenroom</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="fastai data transform" />
<meta name="author" content="Bowen" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="borrow code from https://docs.fast.ai/data.transforms.html and add some tips" />
<meta property="og:description" content="borrow code from https://docs.fast.ai/data.transforms.html and add some tips" />
<link rel="canonical" href="https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-data-transform.html" />
<meta property="og:url" content="https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-data-transform.html" />
<meta property="og:site_name" content="Bowenroom" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-31T00:00:00-06:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Bowen"},"description":"borrow code from https://docs.fast.ai/data.transforms.html and add some tips","@type":"BlogPosting","headline":"fastai data transform","dateModified":"2021-01-31T00:00:00-06:00","datePublished":"2021-01-31T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-data-transform.html"},"url":"https://bowenroom.github.io/myBlog/pytorch/fastai/2021/01/31/fastai-data-transform.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://bowenroom.github.io/myBlog/feed.xml" title="Bowenroom" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/myBlog/">Bowenroom</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/myBlog/about/">About Me</a><a class="page-link" href="/myBlog/search/">Search</a><a class="page-link" href="/myBlog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">fastai data transform</h1><p class="page-description">borrow code from https://docs.fast.ai/data.transforms.html and add some tips</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-01-31T00:00:00-06:00" itemprop="datePublished">
        Jan 31, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Bowen</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      15 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/myBlog/categories/#pytorch">pytorch</a>
        &nbsp;
      
        <a class="category-tags-link" href="/myBlog/categories/#fastai">fastai</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/bowenroom/myBlog/tree/master/_notebooks/2021-01-31-fastai-data-transform.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/myBlog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/bowenroom/myBlog/master?filepath=_notebooks%2F2021-01-31-fastai-data-transform.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/myBlog/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/bowenroom/myBlog/blob/master/_notebooks/2021-01-31-fastai-data-transform.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/myBlog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Helper-functions-for-processing-data-and-basic-transforms">Helper functions for processing data and basic transforms </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Get,-split,-and-label">Get, split, and label </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Get">Get </a></li>
<li class="toc-entry toc-h3"><a href="#Split">Split </a></li>
<li class="toc-entry toc-h3"><a href="#Label">Label </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#End-to-end-dataset-example-with-MNIST">End-to-end dataset example with MNIST </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-01-31-fastai-data-transform.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.torch_basics</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.data.core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.data.load</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.data.external</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Helper-functions-for-processing-data-and-basic-transforms">
<a class="anchor" href="#Helper-functions-for-processing-data-and-basic-transforms" aria-hidden="true"><span class="octicon octicon-link"></span></a>Helper functions for processing data and basic transforms<a class="anchor-link" href="#Helper-functions-for-processing-data-and-basic-transforms"> </a>
</h1>
<blockquote>
<p>Functions for getting, splitting, and labeling data, as well as generic transforms</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Get,-split,-and-label">
<a class="anchor" href="#Get,-split,-and-label" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get, split, and label<a class="anchor-link" href="#Get,-split,-and-label"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For most data source creation we need functions to get a list of items, split them in to train/valid sets, and label them. fastai provides functions to make each of these steps easy (especially when combined with <code>fastai.data.blocks</code>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Get">
<a class="anchor" href="#Get" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get<a class="anchor-link" href="#Get"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First we'll look at functions that <em>get</em> a list of items (generally file names).</p>
<p>We'll use <em>tiny MNIST</em> (a subset of MNIST with just two classes, <code>7</code>s and <code>3</code>s) for our examples/tests throughout this page.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">MNIST_TINY</span><span class="p">)</span>
<span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'train'</span><span class="p">)</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#2) [Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train/7')]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_get_files</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">/</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fs</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
           <span class="ow">and</span> <span class="p">((</span><span class="ow">not</span> <span class="n">extensions</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="s1">'.</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">'</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="s2">"Get all the files in `path` with optional `extensions`, optionally with `recurse`, only in `folders`, if specified."</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">folders</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="n">setify</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">recurse</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">p</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="n">followlinks</span><span class="p">)):</span> <span class="c1"># returns (dirpath, dirnames, filenames)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">d</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>                         <span class="n">d</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">o</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="s1">'.'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">_get_files</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">extensions</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">is_file</span><span class="p">()]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">_get_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">extensions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is the most general way to grab a bunch of file names from disk. If you pass <code>extensions</code> (including the <code>.</code>) then returned file names are filtered by that list. Only those files directly in <code>path</code> are included, unless you pass <code>recurse</code>, in which case all child folders are also searched recursively. <code>folders</code> is an optional list of directories to limit the search to.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [Path('/home/ubuntu/.fastai/data/mnist_tiny/valid'),Path('/home/ubuntu/.fastai/data/mnist_tiny/models'),Path('/home/ubuntu/.fastai/data/mnist_tiny/test'),Path('/home/ubuntu/.fastai/data/mnist_tiny/labels.csv'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train')]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t3</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'train'</span><span class="o">/</span><span class="s1">'3'</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="s1">'.png'</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">t7</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'train'</span><span class="o">/</span><span class="s1">'7'</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="s1">'.png'</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">t</span>  <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'train'</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="s1">'.png'</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">t7</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">get_files</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'train'</span><span class="o">/</span><span class="s1">'3'</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="s1">'.jpg'</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="s1">'.png'</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="s1">'train'</span><span class="p">)))</span>
<span class="n">t</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#709) [Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3/7634.png'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3/8672.png'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3/8406.png'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3/9386.png'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3/7678.png'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3/7332.png'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3/9424.png'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3/7189.png'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3/9759.png'),Path('/home/ubuntu/.fastai/data/mnist_tiny/train/3/9141.png')...]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It's often useful to be able to create functions with customized behavior. <code>fastai.data</code> generally uses functions named as CamelCase verbs ending in <code>er</code> to create these functions. <code>FileGetter</code> is a simple example of such a function creator.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">FileGetter</span><span class="p">(</span><span class="n">suf</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">"Create `get_files` partial function that searches path suffix `suf`, only in `folders`, if specified, and passes along args"</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="n">extensions</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="n">folders</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_files</span><span class="p">(</span><span class="n">o</span><span class="o">/</span><span class="n">suf</span><span class="p">,</span> <span class="n">extensions</span><span class="p">,</span> <span class="n">recurse</span><span class="p">,</span> <span class="n">folders</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fpng</span> <span class="o">=</span> <span class="n">FileGetter</span><span class="p">(</span><span class="n">extensions</span><span class="o">=</span><span class="s1">'.png'</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t7</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">fpng</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'train'</span><span class="o">/</span><span class="s1">'7'</span><span class="p">)))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">fpng</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'train'</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
<span class="n">fpng_r</span> <span class="o">=</span> <span class="n">FileGetter</span><span class="p">(</span><span class="n">extensions</span><span class="o">=</span><span class="s1">'.png'</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">fpng_r</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'train'</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">image_extensions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">types_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'image/'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">"Get image files in `path` recursively, only in `folders`, if specified."</span>
    <span class="k">return</span> <span class="n">get_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="n">image_extensions</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="n">folders</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is simply <code>get_files</code> called with a list of standard image extensions.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="s1">'train'</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">ImageGetter</span><span class="p">(</span><span class="n">suf</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">"Create `get_image_files` partial that searches suffix `suf` and passes along `kwargs`, only in `folders`, if specified"</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="n">folders</span><span class="p">):</span> <span class="k">return</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">o</span><span class="o">/</span><span class="n">suf</span><span class="p">,</span> <span class="n">recurse</span><span class="p">,</span> <span class="n">folders</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Same as <code>FileGetter</code>, but for image extensions.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">get_files</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'train'</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="s1">'.png'</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="s1">'3'</span><span class="p">)),</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">ImageGetter</span><span class="p">(</span>   <span class="s1">'train'</span><span class="p">,</span>                    <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="s1">'3'</span><span class="p">)(</span><span class="n">path</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_text_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">"Get text files in `path` recursively, only in `folders`, if specified."</span>
    <span class="k">return</span> <span class="n">get_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">'.txt'</span><span class="p">],</span> <span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="n">folders</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ItemGetter</span><span class="p">(</span><span class="n">ItemTransform</span><span class="p">):</span>
    <span class="s2">"Creates a proper transform that applies `itemgetter(i)` (even on a tuple)"</span>
    <span class="n">_retain</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">ItemGetter</span><span class="p">(</span><span class="mi">1</span><span class="p">)((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span>  <span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ItemGetter</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">L</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ItemGetter</span><span class="p">(</span><span class="mi">1</span><span class="p">)([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]),</span>  <span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ItemGetter</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])),</span>  <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">AttrGetter</span><span class="p">(</span><span class="n">ItemTransform</span><span class="p">):</span>
    <span class="s2">"Creates a proper transform that applies `attrgetter(nm)` (even on a tuple)"</span>
    <span class="n">_retain</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="n">store_attr</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">AttrGetter</span><span class="p">(</span><span class="s1">'shape'</span><span class="p">)(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])),</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">AttrGetter</span><span class="p">(</span><span class="s1">'shape'</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])([</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Split">
<a class="anchor" href="#Split" aria-hidden="true"><span class="octicon octicon-link"></span></a>Split<a class="anchor-link" href="#Split"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The next set of functions are used to <em>split</em> data into training and validation sets. The functions return two lists - a list of indices or masks for each of training and validation sets.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">RandomSplitter</span><span class="p">(</span><span class="n">valid_pct</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">"Create function that splits `items` between train/val with `valid_pct` randomly."</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">rand_idx</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_pct</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rand_idx</span><span class="p">[</span><span class="n">cut</span><span class="p">:],</span><span class="n">rand_idx</span><span class="p">[:</span><span class="n">cut</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">src</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">RandomSplitter</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">trn</span><span class="p">,</span><span class="n">val</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">assert</span> <span class="mi">0</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">trn</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">trn</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trn</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
<span class="c1"># test random seed consistency</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">src</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trn</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Use scikit-learn train_test_split. This allow to <em>split</em> items in a stratified fashion (uniformely according to the ‘labels‘ distribution)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">TrainTestSplitter</span><span class="p">(</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="s2">"Split `items` into random train and test subsets using sklearn train_test_split utility."</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">train</span><span class="p">,</span><span class="n">valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">range_of</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
                                        <span class="n">stratify</span><span class="o">=</span><span class="n">stratify</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="n">train_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="n">train</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">src</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">TrainTestSplitter</span><span class="p">(</span><span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
<span class="n">trn</span><span class="p">,</span><span class="n">val</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">assert</span> <span class="mi">0</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">trn</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">trn</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trn</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

<span class="c1"># test random seed consistency</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">src</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trn</span><span class="p">)</span>

<span class="c1"># test labels distribution consistency</span>
<span class="c1"># there should be test_size % of zeroes and ones respectively in the validation set</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">])</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">IndexSplitter</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">):</span>
    <span class="s2">"Split `items` so that `val_idx` are in the validation set and the others in the training set"</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="n">train_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">range_of</span><span class="p">(</span><span class="n">o</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">use_list</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">,</span> <span class="n">use_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">splitter</span> <span class="o">=</span> <span class="n">IndexSplitter</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">splitter</span><span class="p">(</span><span class="n">items</span><span class="p">),[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_grandparent_idxs</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span> <span class="k">return</span> <span class="n">mask2idxs</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">L</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_inner</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="n">n</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">GrandparentSplitter</span><span class="p">(</span><span class="n">train_name</span><span class="o">=</span><span class="s1">'train'</span><span class="p">,</span> <span class="n">valid_name</span><span class="o">=</span><span class="s1">'valid'</span><span class="p">):</span>
    <span class="s2">"Split `items` from the grand parent folder names (`train_name` and `valid_name`)."</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_grandparent_idxs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">train_name</span><span class="p">),</span><span class="n">_grandparent_idxs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">valid_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="o">/</span><span class="s1">'train/3/9932.png'</span><span class="p">,</span> <span class="n">path</span><span class="o">/</span><span class="s1">'valid/7/7189.png'</span><span class="p">,</span> 
          <span class="n">path</span><span class="o">/</span><span class="s1">'valid/7/7320.png'</span><span class="p">,</span> <span class="n">path</span><span class="o">/</span><span class="s1">'train/7/9833.png'</span><span class="p">,</span>  
          <span class="n">path</span><span class="o">/</span><span class="s1">'train/3/7666.png'</span><span class="p">,</span> <span class="n">path</span><span class="o">/</span><span class="s1">'valid/3/925.png'</span><span class="p">,</span>
          <span class="n">path</span><span class="o">/</span><span class="s1">'train/7/724.png'</span><span class="p">,</span> <span class="n">path</span><span class="o">/</span><span class="s1">'valid/3/93055.png'</span><span class="p">]</span>
<span class="n">splitter</span> <span class="o">=</span> <span class="n">GrandparentSplitter</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">splitter</span><span class="p">(</span><span class="n">fnames</span><span class="p">),[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fnames2</span> <span class="o">=</span> <span class="n">fnames</span> <span class="o">+</span> <span class="p">[</span><span class="n">path</span><span class="o">/</span><span class="s1">'test/3/4256.png'</span><span class="p">,</span> <span class="n">path</span><span class="o">/</span><span class="s1">'test/7/2345.png'</span><span class="p">,</span> <span class="n">path</span><span class="o">/</span><span class="s1">'valid/7/6467.png'</span><span class="p">]</span>
<span class="n">splitter</span> <span class="o">=</span> <span class="n">GrandparentSplitter</span><span class="p">(</span><span class="n">train_name</span><span class="o">=</span><span class="p">(</span><span class="s1">'train'</span><span class="p">,</span> <span class="s1">'valid'</span><span class="p">),</span> <span class="n">valid_name</span><span class="o">=</span><span class="s1">'test'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">splitter</span><span class="p">(</span><span class="n">fnames2</span><span class="p">),[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">],[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">FuncSplitter</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="s2">"Split `items` by result of `func` (`True` for validation, `False` for training set)."</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="n">val_idx</span> <span class="o">=</span> <span class="n">mask2idxs</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">o_</span><span class="p">)</span> <span class="k">for</span> <span class="n">o_</span> <span class="ow">in</span> <span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IndexSplitter</span><span class="p">(</span><span class="n">val_idx</span><span class="p">)(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splitter</span> <span class="o">=</span> <span class="n">FuncSplitter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">'valid'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">splitter</span><span class="p">(</span><span class="n">fnames</span><span class="p">),[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">MaskSplitter</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
    <span class="s2">"Split `items` depending on the value of `mask`."</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">IndexSplitter</span><span class="p">(</span><span class="n">mask2idxs</span><span class="p">(</span><span class="n">mask</span><span class="p">))(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="n">splitter</span> <span class="o">=</span> <span class="n">MaskSplitter</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">splitter</span><span class="p">(</span><span class="n">items</span><span class="p">),[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">FileSplitter</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="s2">"Split `items` by providing file `fname` (contains names of valid items separated by newline)."</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">valid</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">FuncSplitter</span><span class="p">(</span><span class="n">_func</span><span class="p">)(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="s1">'valid.txt'</span>
    <span class="n">fname</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">Path</span><span class="p">(</span><span class="n">fnames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]]))</span>
    <span class="n">splitter</span> <span class="o">=</span> <span class="n">FileSplitter</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">splitter</span><span class="p">(</span><span class="n">fnames</span><span class="p">),[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">ColSplitter</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">'is_valid'</span><span class="p">):</span>
    <span class="s2">"Split `items` (supposed to be a dataframe) by value in `col`"</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">"ColSplitter only works when your items are a pandas DataFrame"</span>
        <span class="n">valid_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">o</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'bool'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IndexSplitter</span><span class="p">(</span><span class="n">mask2idxs</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">))(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'a'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="s1">'b'</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">]})</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">ColSplitter</span><span class="p">(</span><span class="s1">'b'</span><span class="p">)(</span><span class="n">df</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]])</span>
<span class="c1">#Works with strings or index</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">ColSplitter</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">df</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">splits</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]])</span>
<span class="c1"># does not get confused if the type of 'is_valid' is integer, but it meant to be a yes/no</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'a'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="s1">'is_valid'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]})</span>
<span class="n">splits_by_int</span> <span class="o">=</span> <span class="n">ColSplitter</span><span class="p">(</span><span class="s1">'is_valid'</span><span class="p">)(</span><span class="n">df</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">splits_by_int</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">RandomSubsetSplitter</span><span class="p">(</span><span class="n">train_sz</span><span class="p">,</span> <span class="n">valid_sz</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">"Take randoms subsets of `splits` with `train_sz` and `valid_sz`"</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">train_sz</span> <span class="o">&lt;</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">valid_sz</span> <span class="o">&lt;</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">train_sz</span> <span class="o">+</span> <span class="n">valid_sz</span> <span class="o">&lt;=</span> <span class="mf">1.</span>

    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">train_len</span><span class="p">,</span><span class="n">valid_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">*</span><span class="n">train_sz</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">*</span><span class="n">valid_sz</span><span class="p">)</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">idxs</span><span class="p">[:</span><span class="n">train_len</span><span class="p">],</span><span class="n">idxs</span><span class="p">[</span><span class="n">train_len</span><span class="p">:</span><span class="n">train_len</span><span class="o">+</span><span class="n">valid_len</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="n">valid_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">RandomSubsetSplitter</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)(</span><span class="n">items</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Label">
<a class="anchor" href="#Label" aria-hidden="true"><span class="octicon octicon-link"></span></a>Label<a class="anchor-link" href="#Label"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The final set of functions is used to <em>label</em> a single item of data.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">parent_label</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="s2">"Label `item` with the parent folder name."</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that <code>parent_label</code> doesn't have anything customize, so it doesn't return a function - you can just use it directly.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">parent_label</span><span class="p">(</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">'3'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">parent_label</span><span class="p">(</span><span class="s2">"fastai_dev/dev/data/mnist_tiny/train/3/9932.png"</span><span class="p">),</span> <span class="s1">'3'</span><span class="p">)</span>
<span class="p">[</span><span class="n">parent_label</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>['3', '7', '7', '7', '3', '3', '7', '3']</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RegexLabeller</span><span class="p">():</span>
    <span class="s2">"Label `item` with regex `pat`."</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pat</span><span class="o">.</span><span class="n">match</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pat</span><span class="o">.</span><span class="n">search</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">res</span><span class="p">,</span><span class="sa">f</span><span class="s1">'Failed to find "</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pat</span><span class="si">}</span><span class="s1">" in "</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">"'</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>RegexLabeller</code> is a very flexible function since it handles any regex search of the stringified item. Pass <code>match=True</code> to use <code>re.match</code> (i.e. check only start of string), or <code>re.search</code> otherwise (default).</p>
<p>For instance, here's an example the replicates the previous <code>parent_label</code> results.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">RegexLabeller</span><span class="p">(</span><span class="sa">fr</span><span class="s1">'</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">(\d)</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">'3'</span><span class="p">)</span>
<span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>['3', '7', '7', '7', '3', '3', '7', '3']</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">RegexLabeller</span><span class="p">(</span><span class="sa">r</span><span class="s1">'(\d*)'</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="s1">'9932'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ColReader</span><span class="p">(</span><span class="n">DisplayedTransform</span><span class="p">):</span>
    <span class="s2">"Read `cols` in `row` with potential `pref` and `suff`"</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">pref</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">suff</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">label_delim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pref</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pref</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="k">else</span> <span class="n">pref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">r</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="s1">'name'</span> <span class="ow">or</span> <span class="n">c</span><span class="o">==</span><span class="s1">'cat'</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pref</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suff</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_delim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">o</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_delim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pref</span><span class="si">}{</span><span class="n">o</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">suff</span><span class="si">}</span><span class="s1">'</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_delim</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_one</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_do_one</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>cols</code> can be a list of column names or a list of indices (or a mix of both). If <code>label_delim</code> is passed, the result is split using it.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'a'</span><span class="p">:</span> <span class="s1">'a b c d'</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="s1">'b'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'1 2'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'1 2 3'</span><span class="p">]})</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">ColReader</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="n">pref</span><span class="o">=</span><span class="s1">'0'</span><span class="p">,</span> <span class="n">suff</span><span class="o">=</span><span class="s1">'1'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()],</span> <span class="s1">'0a1 0b1 0c1 0d1'</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">ColReader</span><span class="p">(</span><span class="s1">'b'</span><span class="p">,</span> <span class="n">label_delim</span><span class="o">=</span><span class="s1">' '</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()],</span> <span class="p">[[</span><span class="s1">'1'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'0'</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span><span class="s1">'1'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'3'</span><span class="p">]])</span>

<span class="n">df</span><span class="p">[</span><span class="s1">'a1'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">ColReader</span><span class="p">([</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'a1'</span><span class="p">],</span> <span class="n">pref</span><span class="o">=</span><span class="s1">'0'</span><span class="p">,</span> <span class="n">suff</span><span class="o">=</span><span class="s1">'1'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()],</span> <span class="p">[</span><span class="n">L</span><span class="p">(</span><span class="s1">'0a1'</span><span class="p">,</span> <span class="s1">'0a1'</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="s1">'0b1'</span><span class="p">,</span> <span class="s1">'0b1'</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="s1">'0c1'</span><span class="p">,</span> <span class="s1">'0c1'</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="s1">'0d1'</span><span class="p">,</span> <span class="s1">'0d1'</span><span class="p">)])</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'a'</span><span class="p">:</span> <span class="p">[</span><span class="n">L</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">)]})</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">ColReader</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()],</span> <span class="p">[</span><span class="n">L</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">)])</span>

<span class="n">df</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">ColReader</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])],</span> <span class="p">[</span><span class="n">L</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CategoryMap</span><span class="p">(</span><span class="n">CollBase</span><span class="p">):</span>
    <span class="s2">"Collection of categories with the reverse mapping in `o2i`"</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_na</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_categorical_dtype</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span> <span class="n">use_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#Remove non-used categories while keeping order</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span> <span class="n">items</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="s1">'unique'</span><span class="p">):</span> <span class="n">col</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">use_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># `o==o` is the generalized definition of non-NaN used by Pandas</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">o</span><span class="o">==</span><span class="n">o</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sort</span><span class="p">:</span> <span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">sorted</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="s1">'#na#'</span> <span class="o">+</span> <span class="n">items</span> <span class="k">if</span> <span class="n">add_na</span> <span class="k">else</span> <span class="n">items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o2i</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">val2idx</span><span class="p">())</span> <span class="k">if</span> <span class="n">add_na</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">val2idx</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">map_objs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">objs</span><span class="p">):</span>
        <span class="s2">"Map `objs` to IDs"</span>
        <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o2i</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">map_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ids</span><span class="p">):</span>
        <span class="s2">"Map `ids` to objects in vocab"</span>
        <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="n">all_equal</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">o2i</span><span class="p">,</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">map_objs</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">map_ids</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">o2i</span><span class="p">[</span><span class="s1">'unseen label'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">add_na</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="s1">'#na#'</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">o2i</span><span class="p">,</span> <span class="p">{</span><span class="s1">'#na#'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="mi">3</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]),</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">o2i</span><span class="p">,</span> <span class="p">{</span><span class="mi">4</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">col</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">([</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'H'</span><span class="p">,</span><span class="s1">'L'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">'H'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="s1">'H'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'L'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">o2i</span><span class="p">,</span> <span class="p">{</span><span class="s1">'H'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">'M'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">'L'</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">col</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">([</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'H'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">'H'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">,</span><span class="s1">'L'</span><span class="p">],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="s1">'H'</span><span class="p">,</span><span class="s1">'M'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">o2i</span><span class="p">,</span> <span class="p">{</span><span class="s1">'H'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">'M'</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Categorize</span><span class="p">(</span><span class="n">DisplayedTransform</span><span class="p">):</span>
    <span class="s2">"Reversible transform of category string to `vocab` id"</span>
    <span class="n">loss_func</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">CrossEntropyLossFlat</span><span class="p">(),</span><span class="mi">1</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_na</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">vocab</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">vocab</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">add_na</span><span class="o">=</span><span class="n">add_na</span><span class="p">)</span>
        <span class="n">store_attr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsets</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dsets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">,</span> <span class="n">add_na</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">add_na</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TensorCategory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">o2i</span><span class="p">[</span><span class="n">o</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Label '</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">' was not included in the training dataset"</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">Category</span>      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span>    <span class="p">[</span><span class="n">o</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ShowTitle</span><span class="p">):</span> <span class="n">_show_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'label'</span><span class="p">:</span> <span class="s1">'category'</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cat</span> <span class="o">=</span> <span class="n">Categorize</span><span class="p">()</span>
<span class="n">tds</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">([</span><span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">],</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="n">cat</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="p">[</span><span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="s1">'cat'</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">'dog'</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">show_at</span><span class="p">(</span><span class="n">tds</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">'cat'</span><span class="p">)</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">cat</span><span class="p">(</span><span class="s1">'bird'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cat</span> <span class="o">=</span> <span class="n">Categorize</span><span class="p">(</span><span class="n">add_na</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tds</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">([</span><span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">],</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="n">cat</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="p">[</span><span class="s1">'#na#'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="s1">'cat'</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">'dog'</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">show_at</span><span class="p">(</span><span class="n">tds</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">'cat'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cat</span> <span class="o">=</span> <span class="n">Categorize</span><span class="p">(</span><span class="n">vocab</span><span class="o">=</span><span class="p">[</span><span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_na</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tds</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">([</span><span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">],</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="n">cat</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="p">[</span><span class="s1">'#na#'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="s1">'dog'</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">'cat'</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">show_at</span><span class="p">(</span><span class="n">tds</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">'cat'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">MultiCategorize</span><span class="p">(</span><span class="n">Categorize</span><span class="p">):</span>
    <span class="s2">"Reversible transform of multi-category strings to `vocab` id"</span>
    <span class="n">loss_func</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">BCEWithLogitsLossFlat</span><span class="p">(),</span><span class="mi">1</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_na</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">vocab</span><span class="o">=</span><span class="n">vocab</span><span class="p">,</span><span class="n">add_na</span><span class="o">=</span><span class="n">add_na</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="n">vocab</span><span class="o">==</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsets</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dsets</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">:</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">add_na</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">add_na</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">o2i</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">o</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">o</span> <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">o2i</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">diff_str</span> <span class="o">=</span> <span class="s2">"', '"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Labels '</span><span class="si">{</span><span class="n">diff_str</span><span class="si">}</span><span class="s2">' were not included in the training dataset"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TensorMultiCategory</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">o2i</span><span class="p">[</span><span class="n">o_</span><span class="p">]</span> <span class="k">for</span> <span class="n">o_</span> <span class="ow">in</span> <span class="n">o</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">MultiCategory</span>      <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span>    <span class="p">[</span><span class="n">o_</span><span class="p">]</span> <span class="k">for</span> <span class="n">o_</span> <span class="ow">in</span> <span class="n">o</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">MultiCategory</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">';'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">show_title</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">)),</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cat</span> <span class="o">=</span> <span class="n">MultiCategorize</span><span class="p">()</span>
<span class="n">tds</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">([[</span><span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">],</span> <span class="p">[]],</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="n">cat</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tds</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">TensorMultiCategory</span><span class="p">([]))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="p">([</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]),</span> <span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="p">([]),</span> <span class="n">tensor</span><span class="p">([]))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">decode</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span> <span class="p">[</span><span class="s1">'b'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">decode</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">])</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">show_at</span><span class="p">(</span><span class="n">tds</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">'a;c'</span><span class="p">)</span>

<span class="c1"># if vocab supplied, ensure it maintains its order (i.e., it doesn't sort)</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">MultiCategorize</span><span class="p">(</span><span class="n">vocab</span><span class="o">=</span><span class="p">[</span><span class="s1">'z'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="p">[</span><span class="s1">'z'</span><span class="p">,</span><span class="s1">'y'</span><span class="p">,</span><span class="s1">'x'</span><span class="p">])</span>

<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">cat</span><span class="p">(</span><span class="s1">'bird'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">OneHotEncode</span><span class="p">(</span><span class="n">DisplayedTransform</span><span class="p">):</span>
    <span class="s2">"One-hot encodes targets"</span>
    <span class="n">order</span><span class="o">=</span><span class="mi">2</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="n">store_attr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsets</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="s1">'vocab'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">warn</span><span class="p">(</span><span class="s2">"Couldn't infer the number of classes, please pass a value for `c` at init"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">TensorMultiCategory</span><span class="p">(</span><span class="n">one_hot</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">one_hot_decode</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Works in conjunction with <code>MultiCategorize</code> or on its own if you have one-hot encoded targets (pass a <code>vocab</code> for decoding and <code>do_encode=False</code> in this case)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_tfm</span> <span class="o">=</span> <span class="n">OneHotEncode</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">_tfm</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">_tfm</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tds</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">([[</span><span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">],</span> <span class="p">[]],</span> <span class="p">[[</span><span class="n">MultiCategorize</span><span class="p">(),</span> <span class="n">OneHotEncode</span><span class="p">()]])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tds</span><span class="o">.</span><span class="n">decode</span><span class="p">([</span><span class="n">tensor</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])]),</span> <span class="p">[[</span><span class="s1">'b'</span><span class="p">,</span><span class="s1">'c'</span><span class="p">]])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">tds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">TensorMultiCategory</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">show_at</span><span class="p">(</span><span class="n">tds</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="s1">'a;c'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">EncodedMultiCategorize</span><span class="p">(</span><span class="n">Categorize</span><span class="p">):</span>
    <span class="s2">"Transform of one-hot encoded multi-category that decodes with `vocab`"</span>
    <span class="n">loss_func</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">BCEWithLogitsLossFlat</span><span class="p">(),</span><span class="mi">1</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">vocab</span><span class="o">==</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">TensorMultiCategory</span><span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">MultiCategory</span> <span class="p">(</span><span class="n">one_hot_decode</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_tfm</span> <span class="o">=</span> <span class="n">EncodedMultiCategorize</span><span class="p">(</span><span class="n">vocab</span><span class="o">=</span><span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">_tfm</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">_tfm</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])),</span> <span class="n">TensorMultiCategory</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">_tfm</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">tensor</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])),</span> <span class="p">[</span><span class="s1">'b'</span><span class="p">,</span><span class="s1">'c'</span><span class="p">])</span>

<span class="n">_tfm2</span> <span class="o">=</span> <span class="n">EncodedMultiCategorize</span><span class="p">(</span><span class="n">vocab</span><span class="o">=</span><span class="p">[</span><span class="s1">'c'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">_tfm2</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="p">[</span><span class="s1">'c'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RegressionSetup</span><span class="p">(</span><span class="n">DisplayedTransform</span><span class="p">):</span>
    <span class="s2">"Transform that floatifies targets"</span>
    <span class="n">loss_func</span><span class="o">=</span><span class="n">MSELossFlat</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="n">store_attr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">tensor</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">TitledFloat</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">TitledTuple</span><span class="p">(</span><span class="n">o_</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">o_</span> <span class="ow">in</span> <span class="n">o</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsets</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'__len__'</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_tfm</span> <span class="o">=</span> <span class="n">RegressionSetup</span><span class="p">()</span>
<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">RegressionSetup</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">),))</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span> <span class="n">RegressionSetup</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="p">]),))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_c</span><span class="p">(</span><span class="n">dls</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="k">return</span> <span class="n">dls</span><span class="o">.</span><span class="n">c</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="s1">'after_item'</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">'c'</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="k">return</span> <span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">after_item</span><span class="o">.</span><span class="n">c</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="s1">'after_batch'</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">'c'</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="k">return</span> <span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">c</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="s1">'vocab'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">is_listy</span><span class="p">(</span><span class="n">vocab</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span> <span class="n">vocab</span> <span class="o">=</span> <span class="n">vocab</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="End-to-end-dataset-example-with-MNIST">
<a class="anchor" href="#End-to-end-dataset-example-with-MNIST" aria-hidden="true"><span class="octicon octicon-link"></span></a>End-to-end dataset example with MNIST<a class="anchor-link" href="#End-to-end-dataset-example-with-MNIST"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's show how to use those functions to grab the mnist dataset in a <code>Datasets</code>. First we grab all the images.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">MNIST_TINY</span><span class="p">)</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we split between train and validation depending on the folder.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splitter</span> <span class="o">=</span> <span class="n">GrandparentSplitter</span><span class="p">()</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">splitter</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<span class="n">train</span><span class="p">,</span><span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">)</span>
<span class="n">train</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span><span class="n">valid</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>((#3) [Path('/home/jhoward/.fastai/data/mnist_tiny/train/7/723.png'),Path('/home/jhoward/.fastai/data/mnist_tiny/train/7/7446.png'),Path('/home/jhoward/.fastai/data/mnist_tiny/train/7/8566.png')],
 (#3) [Path('/home/jhoward/.fastai/data/mnist_tiny/valid/7/946.png'),Path('/home/jhoward/.fastai/data/mnist_tiny/valid/7/9608.png'),Path('/home/jhoward/.fastai/data/mnist_tiny/valid/7/825.png')])</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our inputs are images that we open and convert to tensors, our targets are labeled depending on the parent directory and are categories.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">open_img</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span><span class="n">Path</span><span class="p">):</span> <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">img2tensor</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span> <span class="k">return</span> <span class="n">TensorImage</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">)[</span><span class="kc">None</span><span class="p">])</span>

<span class="n">tfms</span> <span class="o">=</span> <span class="p">[[</span><span class="n">open_img</span><span class="p">,</span> <span class="n">img2tensor</span><span class="p">],</span>
        <span class="p">[</span><span class="n">parent_label</span><span class="p">,</span> <span class="n">Categorize</span><span class="p">()]]</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">tfms</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">train_ds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">xd</span><span class="p">,</span><span class="n">yd</span> <span class="o">=</span> <span class="n">decode_at</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">parent_label</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="n">yd</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span><span class="n">xd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">show_at</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"Greys"</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'3'</span><span class="p">,</span><span class="s1">'7'</span><span class="p">)</span>
<span class="n">test_fig_exists</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ToTensor</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="s2">"Convert item to appropriate tensor class"</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">IntToFloatTensor</span><span class="p">(</span><span class="n">DisplayedTransform</span><span class="p">):</span>
    <span class="s2">"Transform image to float tensor, optionally dividing by 255 (e.g. for images)."</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#Need to run after PIL transforms on the GPU</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">div</span><span class="o">=</span><span class="mf">255.</span><span class="p">,</span> <span class="n">div_mask</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="n">store_attr</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span><span class="n">TensorImage</span><span class="p">):</span> <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">div</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span><span class="n">TensorMask</span> <span class="p">):</span> <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">long</span><span class="p">()</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">div_mask</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span><span class="n">TensorImage</span><span class="p">):</span> <span class="k">return</span> <span class="p">((</span><span class="n">o</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">div</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">div</span> <span class="k">else</span> <span class="n">o</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">TensorImage</span><span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="n">tensor</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span><span class="n">TensorMask</span><span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<span class="n">tfm</span> <span class="o">=</span> <span class="n">IntToFloatTensor</span><span class="p">()</span>
<span class="n">ft</span> <span class="o">=</span> <span class="n">tfm</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ft</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">TensorImage</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ft</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">TensorMask</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span><span class="s1">'torch.FloatTensor'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span><span class="s1">'torch.LongTensor'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ft</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span><span class="s1">'torch.LongTensor'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">broadcast_vec</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="s2">"Make a vector broadcastable over `dim` (out of `ndim` total) by prepending and appending unit axes"</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ndim</span>
    <span class="n">v</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">to_device</span> <span class="k">if</span> <span class="n">cuda</span> <span class="k">else</span> <span class="n">noop</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># @docs</span>
<span class="k">class</span> <span class="nc">Normalize</span><span class="p">(</span><span class="n">DisplayedTransform</span><span class="p">):</span>
    <span class="s2">"Normalize/denorm batch of `TensorImage`"</span>
    <span class="n">parameters</span><span class="p">,</span><span class="n">order</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="s1">'mean'</span><span class="p">,</span> <span class="s1">'std'</span><span class="p">),</span><span class="mi">99</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)):</span> <span class="n">store_attr</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_stats</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">broadcast_vec</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">cuda</span><span class="o">=</span><span class="n">cuda</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">setups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dl</span><span class="p">:</span><span class="n">DataLoader</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span><span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">+</span><span class="mf">1e-7</span>

    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">TensorImage</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">TensorImage</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">to_cpu</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">'cpu'</span> <span class="k">else</span> <span class="n">noop</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">))</span>

    <span class="n">_docs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">encodes</span><span class="o">=</span><span class="s2">"Normalize batch"</span><span class="p">,</span> <span class="n">decodes</span><span class="o">=</span><span class="s2">"Denormalize batch"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mean</span><span class="p">,</span><span class="n">std</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">,[</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span>
<span class="n">mean</span><span class="p">,</span><span class="n">std</span> <span class="o">=</span> <span class="n">broadcast_vec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
<span class="n">batch_tfms</span> <span class="o">=</span> <span class="p">[</span><span class="n">IntToFloatTensor</span><span class="p">(),</span> <span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span><span class="n">std</span><span class="p">)]</span>
<span class="n">tdl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">batch_tfms</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">default_device</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span><span class="p">,</span><span class="n">y</span>  <span class="o">=</span> <span class="n">tdl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">xd</span><span class="p">,</span><span class="n">yd</span> <span class="o">=</span> <span class="n">tdl</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span> <span class="s1">'torch.cuda.FloatTensor'</span> <span class="k">if</span> <span class="n">default_device</span><span class="p">()</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">'cuda'</span> <span class="k">else</span> <span class="s1">'torch.FloatTensor'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">xd</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span> <span class="s1">'torch.LongTensor'</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">TensorImage</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">TensorCategory</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">&lt;</span><span class="mf">0.0</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.5</span>
<span class="k">assert</span> <span class="mi">0</span><span class="o">&lt;</span><span class="n">xd</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="mf">255.</span><span class="o">&lt;</span><span class="mi">1</span>
<span class="k">assert</span> <span class="mi">0</span><span class="o">&lt;</span><span class="n">xd</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="mf">255.</span><span class="o">&lt;</span><span class="mf">0.5</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Just for visuals</span>
<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tdl</span><span class="o">.</span><span class="n">show_batch</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="bowenroom/myBlog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/myBlog/pytorch/fastai/2021/01/31/fastai-data-transform.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/myBlog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/myBlog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/myBlog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>learn DL easily</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/bowenroom" title="bowenroom"><svg class="svg-icon grey"><use xlink:href="/myBlog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/bowenroom1" title="bowenroom1"><svg class="svg-icon grey"><use xlink:href="/myBlog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
